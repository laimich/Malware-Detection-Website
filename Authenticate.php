<?php 
//Michelle Lai
//CS 174 Sec 2, Project
//Authentication page

//Database table information
//admin (username, password) 
    //table is auto created, entry is auto added
//infected (name, sequence)
    //table is auto created, entries are auto added

require_once 'login.php'; //for login and database information
require_once 'sql-functions.php'; //php functions for sql

//create connection
$conn = new mysqli($hn, $un, $pw, $db);
if ($conn->connect_error) die($conn->connect_error);
//ensure database specified in login file exists
if(!check_database_exists($conn, $db)) {
    $conn->close();
    die("Error: Database does not exist. </br>");
}

//salt values for users
$salt1 = "qm&h*";
$salt2 = "pg!@";

//check if table for admin exists
//if not, create table and default auto generated admin account
$table = "admin";
if(!check_table_exists($conn, $table)) {
    //create admin table with username, password columns
    $values = array("username VARCHAR(30) UNIQUE, password TEXT");
    create_table($conn, $table, $values);

    //create default/auto generated admin account
    $username = "admin";
    //make sure to prepend/append salts and hash password
    $pass = "password";
    $encryptedPass = hash('ripemd128', "$salt1$pass$salt2");
    $sqlValues = "\"$username\", \"$encryptedPass\"";
    //create then execute query
    $query = "INSERT INTO $table VALUES($sqlValues)";
    $result = $conn->query($query);        
    if (!$result) die ("Access failed: " . $conn->error);
    // die("Error: Cannot proceed, required information does not exist.");
}

//check if username and password is entered
if (isset($_SERVER['PHP_AUTH_USER']) && isset($_SERVER['PHP_AUTH_PW'])) {
    //get and clean user entered username and password
    $username = mysql_entities_fix_string($conn, $_SERVER['PHP_AUTH_USER']);
    $password = mysql_entities_fix_string($conn, $_SERVER['PHP_AUTH_PW']);
    $encryptedPass = hash('ripemd128', "$salt1$password$salt2");

    //check if username and password combination is correct
    //create and execute query
    $table = "admin";
    //get all users with this username
    $query = "SELECT * FROM $table WHERE username = \"$username\"";
    $result = $conn->query($query);        
    if(!$result) die ("Access failed: " . $conn->error);
    elseif($result->num_rows) {
        //get the row in db with this username
        $row =$result->fetch_array(MYSQLI_ASSOC);
        $result->close();

        //login successful if entered pass equals pass in db for specified user
        if($encryptedPass == $row['password']) {
            //start the session, save values needed
            session_start();
            $_SESSION['username'] = $row['username'];
            //hash the ip and user agent string
            $check = hash('ripemd128', $_SERVER['REMOTE_ADDR'].$_SERVER['HTTP_USER_AGENT']);
            $_SESSION['check'] = $check;
            //set the time of last authenticated to auto log out after 10 min
            $_SESSION['timeSet'] = time();

            echo "You are logged in. </br></br>";
            die("<p><a href=Admin.php>Click here to continue</a></p>");            
        }
        else die("Error: Invalid username/password combination.");
    }
    else die("Error: Invalid username/password combination.");
}
else {
    //display authentication header prompt for username and password
    header('WWW-Authenticate: Basic realm="Restricted Section"');
    header('HTTP/1.0 401 Unauthorized'); 
    die("Please enter your username and password.");
}

$conn->close();

?>